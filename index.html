<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload" href="assets/music/background.mp3" as="audio" crossorigin>
    <title>Our Story</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Great+Vibes&family=Pacifico&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/audio-player.css">

    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/css/uikit.min.css" />
    <!-- Inline data-URI favicon to avoid requesting /favicon.ico (fallback for dev) -->
    <link rel="icon" type="image/png"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQYV2NgYGD4DwABBAEAf49ZxQAAAABJRU5ErkJggg==">
    <meta name="theme-color" content="#ffe6f2">
    <meta name="description"
        content="A romantic, interactive love story with gentle animations, music, and progress indicators.">
    <!-- Optional: preload background music to help browsers get the audio early -->
    <link rel="preload" href="assets/music/background.mp3" as="audio">
    <link rel="preload" href="assets/music/background2.mp3" as="audio">
    <link rel="preload" href="assets/music/background3.mp3" as="audio">
</head>

<body class="hero-locked">
    <div class="cloud-background">
        <div class="cloud-layer"></div>
        <div class="cloud-layer"></div>
        <div class="cloud-layer"></div>
    </div>
    <!-- Skip link for keyboard users -->
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <section class="hero" id="hero" aria-label="Intro">
        <div class="hero-inner">
            <h1 class="hero-title">Are you ready to see yourself through my eyes?</h1>
            <button class="hero-cta" id="hero-cta" type="button">See My World</button>
        </div>
    </section>
    <main id="main-content" class="container" role="main" aria-label="Main story content">
        <!-- Existing story sections: each story section contains a .story-card wrapper used by the typewriter -->
        <div class="scroll-stack-scroller">
            <div class="scroll-stack-inner">
                <div class="story-section" id="section-1" role="region" aria-labelledby="section-1-title">
                    <div class="story-card">
                        <h1 id="section-1-title">The First Notice</h1>
                        <p>
                            The first time I ever noticed you was when you were decorating the 7th â€œAâ€ class board ğŸ¨âœ¨.
                            I didnâ€™t know you back then, but later that day I saw the Principal maâ€™am praising your work
                            during lunch.
                            That was the moment you quietly entered my life ğŸ’­.
                            Somehow, after that day, I started sketching again âœï¸â€”maybe because something about you
                            inspired me.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-1" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-2" role="region" aria-labelledby="section-2-title">
                    <div class="story-card">
                        <h1 id="section-2-title">Table Tennis Discovery</h1>
                        <p>
                            Then I found out you played table tennis ğŸ“.
                            I didnâ€™t even know how to hold the racket properly ğŸ˜…, but I still went to play.
                            I practiced for days, hitting the ball against the wall, just so I wouldnâ€™t embarrass myself
                            when I finally got a chance to play with you ğŸ¤.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-2" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-3" role="region" aria-labelledby="section-3-title">
                    <div class="story-card">
                        <h1 id="section-3-title">First Match Memory</h1>
                        <p>
                            I still remember that dayâ€”you in a blue T-shirt ğŸ’™, your brother beside you while you taught
                            him how to play.
                            That was the first proper match I ever played with youâ€¦ and of course, I lost ğŸ˜„.
                            But what stayed with me was how calmly you lifted the ball when it landed near the white
                            edge line.
                            I donâ€™t know why, but that tiny moment stayed with me ğŸ’«.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-3" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-4" role="region" aria-labelledby="section-4-title">
                    <div class="story-card">
                        <h1 id="section-4-title">The New Bus</h1>
                        <p>
                            Then came the new 7-number bus ğŸšŒ.
                            It was always crowded because it was fast.
                            When Singla maâ€™am divided the students, all I secretly wished was to be in the same bus as
                            you ğŸ¤.
                            At that age, I didnâ€™t know words like â€œloveâ€ or â€œcrush.â€
                            I just wanted to be around you.
                            Even if we sat apartâ€”with just that small gap between our seatsâ€”it still felt special ğŸ«¶.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-4" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-5" role="region" aria-labelledby="section-5-title">
                    <div class="story-card">
                        <h1 id="section-5-title">Small Gestures</h1>
                        <p>
                            Once, my bagâ€™s shoulder strap was hanging and bothering you.
                            I immediately lifted it and rolled it up ğŸ˜³.
                            After that day, I always kept my bag the same wayâ€”
                            secretly hoping for another chance to interact,
                            yet making sure it would never trouble you again.
                            It sounds silly now, but back thenâ€¦ it meant everything ğŸ¥º.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-5" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-6" role="region" aria-labelledby="section-6-title">
                    <div class="story-card">
                        <h1 id="section-6-title">Bus Route Changes</h1>
                        <p>
                            I still remember the bus route changingâ€”from â€œ1 Rupya Chowkâ€ to â€œJhajhar Chungi.â€
                            By then, the girlsâ€™ seats were fixed at the backâ€”you know the reason ğŸ˜”.
                            You usually sat near the window, and Iâ€™d look back again and again just to see you ğŸ‘€.
                            Before getting off, I always slowed down, hoping for one last glimpse.
                            And on days I missed itâ€¦ I felt strangely empty ğŸ’”.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-6" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-7" role="region" aria-labelledby="section-7-title">
                    <div class="story-card">
                        <h1 id="section-7-title">Timings and COVID</h1>
                        <p>
                            Then your bus timing changed when you moved to 10th early for board prep ğŸ“š.
                            Soon after, COVID arrivedâ€”and everything went online ğŸ’».
                            Most of your 10th and my 9th passed behind a screen,
                            but somehowâ€¦ you were always on my mind ğŸŒ™.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-7" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-8" role="region" aria-labelledby="section-8-title">
                    <div class="story-card">
                        <h1 id="section-8-title">School Reopening</h1>
                        <p>
                            When school briefly reopened, I saw you again ğŸ˜Š.
                            I even wrote some of your class papersâ€”10th Maths and 11th Accountancyâ€”
                            since I lived near Sunita maâ€™am and she was my tutor.
                            That small connection made me feel closer to you in a strange, quiet way ğŸ¤.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-8" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-9" role="region" aria-labelledby="section-9-title">
                    <div class="story-card">
                        <h1 id="section-9-title">Hidden Hints</h1>
                        <p>
                            On Teacherâ€™s Day, I sketched our teachers and hid my initial in the drawing âœï¸.
                            Iâ€™d pass by your class during lunch just to catch a glimpse of you.
                            I donâ€™t know when I learned to do all thisâ€”
                            I only know I did it for you ğŸ’­.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-9" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-10" role="region" aria-labelledby="section-10-title">
                    <div class="story-card">
                        <h1 id="section-10-title">Teacher Assistants</h1>
                        <p>
                            When we became teacher assistants, I chose your section on purpose ğŸ˜Œ.
                            I still remember you sitting on the last bench near the gate,
                            and me sitting in the same row, second bench.
                            I even asked questions just to seem sincereâ€”
                            maybeâ€¦ just to earn your attention ğŸ«£.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-10" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-11" role="region" aria-labelledby="section-11-title">
                    <div class="story-card">
                        <h1 id="section-11-title">Teaching Day</h1>
                        <p>
                            The day you were teaching, I wasnâ€™t really listening to the lesson ğŸ˜….
                            I was just making sure the class stayed quiet,
                            so no one would disturb you while you taught ğŸ’›.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-11" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-12" role="region" aria-labelledby="section-12-title">
                    <div class="story-card">
                        <h1 id="section-12-title">Diwali Memories</h1>
                        <p>
                            Diwali in your 11th was unforgettable ğŸª”.
                            You were anchoring, and I was on stage for â€œHum Katha Sunate.â€
                            Watching youâ€”your confidence, your curlsâ€”left me completely stunned âœ¨.
                            After the event, I kept glancing toward your class,
                            hoping to see you again ğŸ’™.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-12" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-13" role="region" aria-labelledby="section-13-title">
                    <div class="story-card">
                        <h1 id="section-13-title">Saved Photo</h1>
                        <p>
                            I found your photo on Sikha maâ€™amâ€™s status and saved it quietly ğŸ“±.
                            Whenever I felt low, looking at it gave me strength.
                            Thatâ€™s when I realizedâ€”I really liked you.
                            But I kept everything buried inside, never even approaching you as a friend ğŸ˜”.
                        </p>
                        <a href="#" class="see-here-link" id="see-saved-photo" aria-label="View saved photo">see
                            here</a>
                    </div>
                    <div class="sketch-bg sketch-bg-13" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-14" role="region" aria-labelledby="section-14-title">
                    <div class="story-card">
                        <h1 id="section-14-title">Teacher's Day Sketches</h1>
                        <p>
                            When you were in 12th and I was in 11th,
                            I showed my sketches hoping youâ€™d notice.
                            When you came to see them, my heart raced ğŸ’“.
                            I even hid a â€œBâ€ in my signatureâ€¦
                            but I donâ€™t think you noticed ğŸ« .
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-14" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-15" role="region" aria-labelledby="section-15-title">
                    <div class="story-card">
                        <h1 id="section-15-title">School Ends, College Begins</h1>
                        <p>
                            Then you left school after 12th ğŸ“.
                            I grew quieter in my own final year.
                            School endedâ€¦ and college began.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-15" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-16" role="region" aria-labelledby="section-16-title">
                    <div class="story-card">
                        <h1 id="section-16-title">LinkedIn Connection</h1>
                        <p>
                            When I joined LinkedIn, I searched your name and saw you were in Hansraj ğŸ˜„.
                            I got excitedâ€”like I found a lost spark again.
                            I even added people from Hansraj,
                            hoping my profile would feel familiar and safe ğŸ¤.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-16" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-17" role="region" aria-labelledby="section-17-title">
                    <div class="story-card">
                        <h1 id="section-17-title">Finally Connected</h1>
                        <p>After around one and a half months, I finally sent you a connection request. You didn't
                            accept it at
                            first as it was random and without any note. I removed it. Waited for 3 weeks. Tried again
                            with a note. After about three months â€” on 27th
                            December
                            2024 ğŸ“… finally you accepted. I still remember the exact dateğŸ’«</p>
                    </div>
                    <div class="sketch-bg sketch-bg-1" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-18" role="region" aria-labelledby="section-18-title">
                    <div class="story-card">
                        <h1 id="section-18-title">First Messages</h1>
                        <p>I felt extremely happy, but then I messed up a bit. I wished you Happy New Year exactly at
                            12:00 AM
                            too eagerğŸ˜…. Then two days later I asked, "How did you celebrate?" which probably made me
                            seem
                            weird or some kind of creepy
                            as it was just random and I am saying sorry for all of mine messages which creepier time by
                            time I know.</p>
                    </div>
                    <div class="sketch-bg sketch-bg-2" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-19" role="region" aria-labelledby="section-19-title">
                    <div class="story-card">
                        <h1 id="section-19-title">Reflections</h1>
                        <p>
                            Looking back, I see my mistakes clearly.
                            I didnâ€™t know how to handle emotions back then.
                            Iâ€™m not justifying anythingâ€”only being honest and saying sorry ğŸ¤.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-3" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-20" role="region" aria-labelledby="section-20-title">
                    <div class="story-card">
                        <h1 id="section-20-title">Precious Memories</h1>
                        <p>These memories are precious to me, even if they weren't perfect. I don't want to replace them
                            or
                            forget them. I know saying all this again might be emotional, maybe even foolish, but I
                            needed to
                            share itğŸ’­.</p>
                    </div>
                    <div class="sketch-bg sketch-bg-4" aria-hidden="true"></div>
                </div>

                <div class="story-section" id="section-21" role="region" aria-labelledby="section-21-title">
                    <div class="story-card">
                        <h1 id="section-21-title">The End... For Now</h1>
                        <p>
                            Thatâ€™s all.
                            I only ask for one simple thing
                            a chance to be your friend ğŸ¤.
                            No pressure. No expectations.
                        </p>
                    </div>
                    <div class="sketch-bg sketch-bg-1" aria-hidden="true"></div>
                </div>

                <div class="scroll-stack-end"></div>
            </div>
        </div>
        <div class="final-section" id="final-section" role="region" aria-labelledby="final-section-title">
            <div class="story-card">
                <h1 id="final-section-title">Will you give me a chance to be your friend?</h1>
                <div class="buttons">
                    <form id="formspree-form" action="https://formspree.io/f/mbdjvlvr" method="POST">
                        <input type="hidden" name="answer" value="She finally said Yes.">
                        <button type="submit" class="yes-btn" aria-label="Answer yes">YES</button>
                    </form>
                    <button class="no-btn" aria-label="Answer no">NO</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Audio Player -->
    <div class="audio-player" id="audio-player" role="region" aria-label="Background music player">
        <div class="player-main">
            <div class="song-info">
                <span class="song-title">Background Music</span>
                <div class="heart-beat"></div>
            </div>
            <div class="player-controls">
                <button class="control-btn" id="play-pause" aria-label="Play or pause background music"
                    aria-pressed="false">â–¶ï¸</button>
                <div class="volume-control">
                    <input type="range" id="volume-slider" min="0" max="100" value="50" aria-label="Volume slider">
                </div>
            </div>
        </div>
        <div class="player-overlay" id="player-overlay">
            <span>Click anywhere to start the music</span>
        </div>
    </div>

    <!-- Core Modules & Enhancements -->
    <!-- Load critical dependencies first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Base initialization -->
    <script src="js/preload.js"></script>
    <script src="js/audioController.js"></script>

    <!-- Scroll and animation modules -->
    <script src="js/scrollFloat.js"></script>
    <script src="js/scrollAnimations.js"></script>
    <script src="js/emotionalBackground.js"></script>
    <script src="js/emotionalTextStyling.js"></script>
    <script src="js/parallax.js"></script>
    <script src="js/progress.js"></script>
    <script src="js/fuzzyText.js"></script>
    <script src="js/decryptedText.js"></script>
    <script src="js/interactiveFlow.js"></script>
    <script src="js/interactions.js"></script>

    <!-- Smooth scrolling -->
    <script src="https://unpkg.com/lenis@1.0.45/dist/lenis.min.js"></script>

    <!-- UIkit JS -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.26/dist/js/uikit-icons.min.js"></script>
    <script>


        // Add AOS attributes to all story sections
        document.querySelectorAll('.story-section').forEach(el => el.setAttribute('data-aos', 'fade-up'));

        /*
          HERO: a gentle permission moment.
          - The page starts "closed" (no scrolling) so the visitor can breathe.
          - The invitation fades in softly, then the button.
          - On consent (CTA click): the hero dissolves, music becomes slightly clearer, the story unlocks.
        */
        // Listen for preloader completion
        window.addEventListener('preloaderHidden', () => {
            console.log('Preloader loading sequence completed');
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Improved scroll reset with multiple fallbacks
            window.scrollTo({ top: 0, left: 0, behavior: 'instant' });
            requestAnimationFrame(() => {
                window.scrollTo(0, 0);
            });

            // Lenis integration for smooth scroll
            if (typeof window.lenis !== 'undefined' && window.lenis) {
                window.lenis.scrollTo(0, { immediate: true });
            }

            const hero = document.getElementById('hero');
            const heroTitle = hero?.querySelector('.hero-title');
            const heroCta = document.getElementById('hero-cta');
            const main = document.getElementById('main-content');
            const firstSection = document.getElementById('section-1');

            // Module initialization status tracker
            window.moduleInitStatus = {
                emotionalBackground: false,
                emotionalTextStyling: false,
                scrollAnimations: false,
                scrollFloat: false,
                interactions: false
            };

            if (window.gsap && heroTitle && heroCta) {
                const intro = gsap.timeline({ defaults: { ease: 'power2.out' } });
                intro
                    .to(heroTitle, { opacity: 1, y: 0, duration: 0.9 })
                    .to(heroCta, { opacity: 1, y: 0, duration: 0.7 }, '-=0.35');
            } else {
                if (heroTitle) {
                    heroTitle.style.opacity = '1';
                    heroTitle.style.transform = 'translateY(0)';
                }
                if (heroCta) {
                    heroCta.style.opacity = '1';
                    heroCta.style.transform = 'translateY(0)';
                }
            }

            if (!heroCta) return;

            // Failsafe timeout: automatically unlock content if hero init fails
            const failsafeTimeout = setTimeout(() => {
                if (document.body.classList.contains('hero-locked')) {
                    console.warn('Failsafe activated: Hero unlock did not complete within timeout. Forcing content display...');
                    document.body.classList.remove('hero-locked');
                    if (main) {
                        main.style.opacity = '1';
                        main.style.pointerEvents = 'auto';
                    }
                    // Initialize all modules as fallback
                    initializeAllModules();
                }
            }, 6000); // 6 second timeout

            heroCta.addEventListener('click', () => {
                clearTimeout(failsafeTimeout); // Cancel failsafe if user clicks CTA

                const ac = window.audioController;
                if (ac?.currentAudio) {
                    if (!ac.isPlaying && typeof ac.playMusic === 'function') {
                        ac.playMusic();
                    }
                    const nextVol = Math.min(0.38, (ac.currentAudio.volume || 0) + 0.12);
                    ac.currentAudio.volume = nextVol;
                    if (typeof ac.setVolume === 'function') {
                        ac.setVolume(Math.round(nextVol * 100));
                    }
                }

                const unlock = () => {
                    document.body.classList.remove('hero-locked');
                    if (main) {
                        main.style.opacity = '';
                        main.style.pointerEvents = '';
                    }
                    requestAnimationFrame(() => {
                        if (firstSection) {
                            firstSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else if (main) {
                            main.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        // Initialize all modules after hero unlock
                        initializeAllModules();
                    });
                };

                if (window.gsap && hero) {
                    const exit = gsap.timeline({
                        defaults: { ease: 'power2.out' },
                        onComplete: () => {
                            hero.style.display = 'none';
                        }
                    });
                    exit
                        .to(hero.querySelector('.hero-inner'), { opacity: 0, y: -8, duration: 0.7 })
                        .to(hero, { opacity: 0, duration: 0.55 }, '-=0.35')
                        .add(() => unlock(), '-=0.35')
                        .fromTo(main, { opacity: 0 }, { opacity: 1, duration: 0.8 }, '-=0.2');
                } else {
                    if (hero) hero.style.display = 'none';
                    unlock();
                }
            }, { once: true });
        });

        // Helper function to initialize all modules
        function initializeAllModules() {
            console.log('Starting module initialization sequence...');

            // Check if GSAP is ready
            if (!window.gsap || !window.ScrollTrigger) {
                console.error('GSAP or ScrollTrigger not available. Waiting for dependencies...');
                let attempts = 0;
                const maxAttempts = 100; // Extended from 20 to 100 (10 seconds instead of 2 seconds)
                const waitInterval = setInterval(() => {
                    if (window.gsap && window.ScrollTrigger) {
                        clearInterval(waitInterval);
                        console.log('âœ“ GSAP/ScrollTrigger loaded after', attempts * 100, 'ms');
                        proceedWithInit();
                    } else if (attempts++ > maxAttempts) {
                        clearInterval(waitInterval);
                        console.error('GSAP/ScrollTrigger failed to load after timeout. Setting up late-load hooks...');
                        // Setup late-load hooks for when dependencies arrive asynchronously
                        setupLateLoadHooks();
                    }
                }, 100);
                return;
            }

            proceedWithInit();

            function proceedWithInit() {
                try {
                    // 1. Initialize emotional background
                    if (typeof window.initEmotionalBackground === 'function' && !window.initEmotionalBackground_done) {
                        window.initEmotionalBackground();
                        window.moduleInitStatus.emotionalBackground = true;
                        console.log('âœ“ emotionalBackground initialized');
                    }
                } catch (e) {
                    console.error('emotionalBackground initialization failed:', e);
                }

                try {
                    // 2. Initialize emotional text styling
                    if (typeof window.initEmotionalTextStyling === 'function' && !window.initEmotionalTextStyling_done) {
                        window.initEmotionalTextStyling();
                        window.moduleInitStatus.emotionalTextStyling = true;
                        console.log('âœ“ emotionalTextStyling initialized');
                    }
                } catch (e) {
                    console.error('emotionalTextStyling initialization failed:', e);
                }

                try {
                    // 3. Initialize scroll animations
                    if (typeof window.initScrollAnimations === 'function' && !window.initScrollAnimations_done) {
                        window.initScrollAnimations();
                        window.moduleInitStatus.scrollAnimations = true;
                        console.log('âœ“ scrollAnimations initialized');
                    }
                } catch (e) {
                    console.error('scrollAnimations initialization failed:', e);
                }

                try {
                    // 4. Initialize ScrollFloat for headings
                    // Wait for DOM to be fully painted
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            if (window.ScrollFloat) {
                                const headings = document.querySelectorAll('.story-section h1, .final-section h1');
                                console.log(`ScrollFloat: Found ${headings.length} headings to animate (expected: 22)`);

                                let initializedCount = 0;
                                headings.forEach((heading, index) => {
                                    if (!heading.dataset.scrollFloatApplied) {
                                        try {
                                            new ScrollFloat(heading);
                                            heading.dataset.scrollFloatApplied = 'true';
                                            initializedCount++;
                                            console.log(`âœ“ ScrollFloat initialized for heading ${index + 1}: "${heading.textContent.substring(0, 30)}..."`);
                                        } catch (e) {
                                            console.error(`âœ— ScrollFloat failed for heading ${index + 1}:`, e);
                                        }
                                    }
                                });

                                window.moduleInitStatus.scrollFloat = true;
                                console.log(`âœ“ ScrollFloat initialization complete: ${initializedCount}/${headings.length} headings animated`);

                                // Verify all headings have scroll-float class
                                setTimeout(() => {
                                    const scrollFloatElements = document.querySelectorAll('.scroll-float');
                                    if (scrollFloatElements.length < headings.length) {
                                        console.warn(`âš  ScrollFloat verification: Only ${scrollFloatElements.length}/${headings.length} headings have scroll-float class`);
                                    }
                                }, 100);
                            }
                        }, 100); // 100ms delay to ensure DOM is settled
                    });
                } catch (e) {
                    console.error('ScrollFloat initialization failed:', e);
                }

                try {
                    // 5. Initialize interactions (word reveals)
                    if (typeof window.initInteractions === 'function' && !window.initInteractions_done) {
                        window.initInteractions();
                        window.moduleInitStatus.interactions = true;
                        console.log('âœ“ interactions initialized');
                    }
                } catch (e) {
                    console.error('interactions initialization failed:', e);
                }

                // 6. Multiple refresh cycles to catch late-rendering elements
                const refreshCycles = [500, 1000, 2000];
                refreshCycles.forEach((delay, index) => {
                    setTimeout(() => {
                        try {
                            // Wait for Lenis if it exists
                            if (window.lenis && typeof window.lenis.update === 'function') {
                                window.lenis.update();
                            }

                            if (window.ScrollTrigger && typeof window.ScrollTrigger.refresh === 'function') {
                                const triggerCount = window.ScrollTrigger.getAll().length;
                                if (triggerCount > 0) {
                                    window.ScrollTrigger.refresh();
                                    console.log(`âœ“ ScrollTrigger refresh cycle ${index + 1}/${refreshCycles.length} (${delay}ms): ${triggerCount} triggers refreshed`);
                                }
                            }
                        } catch (e) {
                            console.error(`ScrollTrigger refresh cycle ${index + 1} failed:`, e);
                        }

                        // Log final summary after last refresh
                        if (index === refreshCycles.length - 1) {
                            const successCount = Object.values(window.moduleInitStatus).filter(v => v).length;
                            console.log(`âœ… Module initialization complete: ${successCount}/5 modules successful`);
                            console.log('Module status:', window.moduleInitStatus);
                        }
                    }, delay);
                });

                // Fallback re-initialization for any missed headings
                setTimeout(() => {
                    if (window.ScrollFloat) {
                        const allHeadings = document.querySelectorAll('.story-section h1, .final-section h1');
                        const uninitializedHeadings = Array.from(allHeadings).filter(h => !h.classList.contains('scroll-float'));

                        if (uninitializedHeadings.length > 0) {
                            console.warn(`âš  Fallback: Re-initializing ${uninitializedHeadings.length} missed headings`);
                            uninitializedHeadings.forEach((heading, index) => {
                                try {
                                    new ScrollFloat(heading);
                                    heading.dataset.scrollFloatApplied = 'true';
                                    console.log(`âœ“ Fallback initialized heading: "${heading.textContent.substring(0, 30)}..."`);
                                } catch (e) {
                                    console.error(`âœ— Fallback failed for heading:`, e);
                                }
                            });

                            // Final refresh after fallback
                            setTimeout(() => {
                                if (window.ScrollTrigger) {
                                    window.ScrollTrigger.refresh();
                                    console.log('âœ“ Final ScrollTrigger refresh after fallback');
                                }
                            }, 300);
                        } else {
                            console.log('âœ… All headings successfully initialized - no fallback needed');
                        }
                    }
                }, 3000);
            }
        }

        // Late-load hooks for when GSAP/ScrollTrigger load asynchronously after timeout
        function setupLateLoadHooks() {
            console.log('Setting up late-load hooks for GSAP/ScrollTrigger...');
            let checkAttempts = 0;
            const maxCheckAttempts = 50; // Check for 5 more seconds

            const lateLoadInterval = setInterval(() => {
                if (window.gsap && window.ScrollTrigger && !window.modulesInitializedAfterLateLoad) {
                    clearInterval(lateLoadInterval);
                    console.log('âœ“ GSAP/ScrollTrigger detected after initial timeout. Proceeding with late initialization...');
                    window.modulesInitializedAfterLateLoad = true;
                    // Re-invoke initialization
                    const tempInit = initializeAllModules.toString();
                    // Extract and re-run proceedWithInit logic
                    const lateInitScript = `
                        try {
                            if (typeof window.initEmotionalBackground === 'function' && !window.initEmotionalBackground_done) {
                                window.initEmotionalBackground();
                                window.moduleInitStatus.emotionalBackground = true;
                                console.log('âœ“ emotionalBackground initialized (late)');
                            }
                        } catch (e) {
                            console.error('emotionalBackground initialization failed:', e);
                        }
                        
                        try {
                            if (typeof window.initEmotionalTextStyling === 'function' && !window.initEmotionalTextStyling_done) {
                                window.initEmotionalTextStyling();
                                window.moduleInitStatus.emotionalTextStyling = true;
                                console.log('âœ“ emotionalTextStyling initialized (late)');
                            }
                        } catch (e) {
                            console.error('emotionalTextStyling initialization failed:', e);
                        }
                        
                        try {
                            if (typeof window.initScrollAnimations === 'function' && !window.initScrollAnimations_done) {
                                window.initScrollAnimations();
                                window.moduleInitStatus.scrollAnimations = true;
                                console.log('âœ“ scrollAnimations initialized (late)');
                            }
                        } catch (e) {
                            console.error('scrollAnimations initialization failed:', e);
                        }
                        
                        try {
                            if (typeof window.initInteractions === 'function' && !window.initInteractions_done) {
                                window.initInteractions();
                                window.moduleInitStatus.interactions = true;
                                console.log('âœ“ interactions initialized (late)');
                            }
                        } catch (e) {
                            console.error('interactions initialization failed:', e);
                        }
                        
                        // Initialize ScrollFloat with full timing sequence
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                if (window.ScrollFloat) {
                                    const headings = document.querySelectorAll('.story-section h1, .final-section h1');
                                    console.log('ScrollFloat (late): Found ' + headings.length + ' headings to animate');
                                    let initializedCount = 0;
                                    headings.forEach((heading, index) => {
                                        if (!heading.dataset.scrollFloatApplied) {
                                            try {
                                                new ScrollFloat(heading);
                                                heading.dataset.scrollFloatApplied = 'true';
                                                initializedCount++;
                                            } catch (e) {
                                                console.error('ScrollFloat failed for heading ' + (index + 1) + ':', e);
                                            }
                                        }
                                    });
                                    window.moduleInitStatus.scrollFloat = true;
                                    console.log('âœ“ ScrollFloat initialization complete (late): ' + initializedCount + '/' + headings.length);
                                }
                            }, 100);
                        });
                        
                        // Multiple refresh cycles
                        const refreshCycles = [500, 1000, 2000];
                        refreshCycles.forEach((delay, index) => {
                            setTimeout(() => {
                                try {
                                    if (window.lenis && typeof window.lenis.update === 'function') {
                                        window.lenis.update();
                                    }
                                    if (window.ScrollTrigger) {
                                        window.ScrollTrigger.refresh();
                                        console.log('âœ“ ScrollTrigger refresh cycle ' + (index + 1) + '/' + refreshCycles.length + ' (late)');
                                    }
                                } catch (e) {
                                    console.error('ScrollTrigger refresh cycle ' + (index + 1) + ' failed (late):', e);
                                }
                            }, delay + 500); // Offset by 500ms since we're starting late
                        });
                        
                        // Fallback re-initialization
                        setTimeout(() => {
                            if (window.ScrollFloat) {
                                const allHeadings = document.querySelectorAll('.story-section h1, .final-section h1');
                                const uninitializedHeadings = Array.from(allHeadings).filter(h => !h.classList.contains('scroll-float'));
                                if (uninitializedHeadings.length > 0) {
                                    console.warn('âš  Fallback (late): Re-initializing ' + uninitializedHeadings.length + ' missed headings');
                                    uninitializedHeadings.forEach((heading) => {
                                        try {
                                            new ScrollFloat(heading);
                                            heading.dataset.scrollFloatApplied = 'true';
                                        } catch (e) {
                                            console.error('Fallback failed for heading:', e);
                                        }
                                    });
                                    setTimeout(() => {
                                        if (window.ScrollTrigger) {
                                            window.ScrollTrigger.refresh();
                                            console.log('âœ“ Final ScrollTrigger refresh after fallback (late)');
                                        }
                                    }, 300);
                                }
                            }
                        }, 3500);
                    `;
                    eval(lateInitScript);
                } else if (checkAttempts++ > maxCheckAttempts) {
                    clearInterval(lateLoadInterval);
                    console.error('GSAP/ScrollTrigger did not load after extended wait. Some features may not work.');
                }
            }, 100);
        }

        // Additional safeguard: hook window load to ensure late-loaded dependencies trigger init
        window.addEventListener('load', () => {
            console.log('Window load event fired');
            if (window.gsap && window.ScrollTrigger && !window.modulesInitializedAfterLateLoad && !window.moduleInitStatus.scrollFloat) {
                console.log('Modules not yet initialized. Triggering late initialization from window load event...');
                window.modulesInitializedAfterLateLoad = true;
                // Invoke a deferred initialization pass
                setTimeout(() => {
                    if (window.ScrollFloat && window.ScrollTrigger.getAll().length === 0) {
                        console.log('âœ“ Window load triggered module initialization catch-up');
                        const headings = document.querySelectorAll('.story-section h1, .final-section h1');
                        headings.forEach((heading) => {
                            if (!heading.dataset.scrollFloatApplied) {
                                try {
                                    new ScrollFloat(heading);
                                    heading.dataset.scrollFloatApplied = 'true';
                                } catch (e) {
                                    console.error('ScrollFloat init from window load failed:', e);
                                }
                            }
                        });
                        setTimeout(() => {
                            if (window.ScrollTrigger) {
                                window.ScrollTrigger.refresh();
                                console.log('âœ“ ScrollTrigger refreshed on window load');
                            }
                        }, 500);
                    }
                }, 200);
            } else {
                // Just perform refresh if modules already initialized
                setTimeout(() => {
                    if (window.ScrollTrigger && window.ScrollTrigger.getAll().length > 0) {
                        window.ScrollTrigger.refresh();
                        console.log('âœ“ ScrollTrigger refreshed on window load');
                    }
                }, 500);
            }
        });
    </script>

    <!-- Image Modal for Saved Photo -->
    <div class="image-modal" id="saved-photo-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-backdrop" id="modal-backdrop"></div>
        <div class="modal-content">
            <button class="modal-close" id="modal-close" aria-label="Close modal">Ã—</button>
            <img src="assets/image/saved.jpg" alt="Saved photo" class="modal-image" id="modal-image">
        </div>
    </div>
</body>

</html>